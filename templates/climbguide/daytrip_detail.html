{% extends "base.html" %}

{% block content %}
<h2>{{ daytrip.title }}</h2>
<div>
    {{ daytrip.date }}<br>
    {{ daytrip.description }}<br>
</div><br>
<div>
    <a href="{% url 'edit_daytrip' daytrip_pk=daytrip.pk%}"><button class="f6 grow no-underline br-pill ph3 pv2 mb2 dib white bg-dark-green" href="#0"type="submit">Update Trip</button></a>
    <a href="{% url 'delete_daytrip' daytrip_pk=daytrip.pk %}"><button class="f6 grow no-underline br-pill ph3 pv2 mb2 dib white bg-dark-green" href="#0"type="submit">Delete Trip</button></a>
</div><br>

<div id='map' style='width: 400px; height: 300px;'></div>
<div class="flex-container">
    <div class="flex-column">
        <h3 class="f4 bold center mw5">Planned Routes</h3>
        <ul class="list pl0 ml0 center mw5 ba b--light-silver br3">
        {% for route in routes %}
            <li class="ph3 pv2 bb b--light-silver">{{ route.name }} | {{ route.route_type }} | {{ route.rating }}</li>
        {% empty %}
            <a href="{% url 'edit_daytrip' daytrip_pk=daytrip.pk %}"><li class="ph3 pv2 bb b--light-silver">Add Routes</li></a>
        {% endfor %}
        </ul>
    </div>
    <div class="flex-column">
        <h3>Log</h3>
        <button id="button-one">Write Log Entry</button>
        <div id="form-one" class="hidden">
            <form id="daytrip-log-form" data-daytripid="{{ daytrip.id }}" class="form-style">
                <div>
                    <label for="log">Log Entry</label>
                    <textarea id="log" placeholder="Write about your trip!"></textarea>
                </div>   
                <div>
                    <button type="submit">Submit Log</button>
                </div>
            </form>
        </div>
        <ul id="current-logs" class="list pl0 ml0 center mw5 ba b--light-silver br3">
        {% for log in logs %}
            <li class="ph3 pv2 bb b--light-silver">{{ log.text }}<h6>{{ log.date_added }}</h6></li>
        {% empty %}
            <li id="no-logs-message">Write an entry!</li>
        {% endfor %}
        </ul>
    </div>
</div>

{{ route_info|json_script:"route_info" }}

{% block scripts %}
<script>
    // Initalize bounding variables
    var minLongitude
    var minLatitude
    var maxLongitude
    var maxLatitude
    // Load map and set to variable map
    mapboxgl.accessToken = '{{mapbox_access_token}}';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-80.793457, 35.782169],
        zoom: 4,
    })
    // Fullscreen Feature
    map.addControl(new mapboxgl.FullscreenControl());
    // Add geolocate control to the map.
    map.addControl(
        new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        trackUserLocation: true
        })
    );
    
    console.log("map loaded!")
    // Get data, load to map, set markers, and initalize bounding varibales
    document.addEventListener("DOMContentLoaded", (e) => {
        const route_info = JSON.parse(document.getElementById("route_info").textContent)
        var latitudeList = []
        var longitudeList = []
        for (let i = 0; i < route_info.length; i++) {
            let route = route_info[i]
            latitudeList.push(route.latitude)
            longitudeList.push(route.longitude)
            console.log(route.name)
            var html =  `<article class="hide-child relative ba b--black-20 mw5 center">
                <img src="https://scontent.flhr3-1.fna.fbcdn.net/v/t1.0-1/p320x320/10419949_10105372167674736_5929675618317299881_n.jpg?oh=fa3bbf4311e61e4637b67ef3be89479f&oe=58C28705" class="db" alt="Photo of Route" />
                <div class="pa2 bt b--black-20">
                <a class="f6 db link dark-blue hover-blue" href="#">${route.name}</a>
                <p class="f6 gray mv1">${route.route_type} | ${route.rating}</p>
                <a class="link tc ph3 pv1 db bg-animate bg-dark-blue hover-bg-blue white f6 br1" href="/routes/detail/${route.pk}">See this Route!</a>
                </div>
                </article>`
            var customPopUp = new mapboxgl.Popup({
                anchor: "bottom",
                offset: { "bottom" : [0, -10] },
                closeOnClick: false,
            }).setHTML(html);
    
            let color = "green"
            var marker = new mapboxgl.Marker(
                {color: color}
            )
                .setLngLat([route.longitude, route.latitude])
                .setPopup(customPopUp)
                .addTo(map);
        }
        console.log(latitudeList)
        console.log(longitudeList)
        minLongitude = Math.min.apply(Math, longitudeList)
        minLatitude = Math.min.apply(Math, latitudeList)
        maxLongitude = Math.max.apply(Math, longitudeList)
        maxLatitude = Math.max.apply(Math, latitudeList)
        console.log(minLongitude)
        console.log(minLatitude)
        console.log(maxLongitude)
        console.log(maxLatitude)
    })
    // Bound mapbox after page loads, based on queried data
    window.addEventListener('load', (e) => {
            map.fitBounds([
                [(minLongitude - 0.05), (minLatitude - 0.1)],
                [(maxLongitude + 0.1), (maxLatitude + 0.1)]
            ])
            console.log("bounds updated!")
        })

    // Log
    const log = document.querySelector("#log")
    const logForm = document.querySelector("#daytrip-log-form")
    const currentLogs = document.querySelector("#current-logs")
    const emptyLogMessage = document.querySelector("#no-logs-message")

    logForm.addEventListener("submit", function (event) {
        event.preventDefault()
        let logData = log.value
        console.log(logData)
        var logObject = makeLogObject(logData)
        console.log(logObject)
        sendLog(logObject)

        if ({"logAdded": true}) {
            if (emptyLogMessage) {
                emptyLogMessage.classList.add("hidden")
            }
            let logEntry = document.createElement("li")
            logEntry.innerHTML = `${logObject["log"]} <h6>{{ log.date_added }}</h6>`
            currentLogs.appendChild(logEntry)
            log.value = ""
        }

    })

    var makeLogObject = function (logData) {
        return {
            log : logData
        }
    }

    var sendLog = function (logObject) {
        const daytrip_pk = logForm.dataset.daytripid
        const url = `/daytrips/detail/${daytrip_pk}/addlog/`
        fetch(url, {
            method: "POST",
            body: JSON.stringify(logObject),
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
                'Accept': 'application/json; charset=UTF-8'
            }
        })
        .then(res => res.json())
        .then(data => console.log(data))
    }
</script>
{% endblock scripts%}
{% endblock %}