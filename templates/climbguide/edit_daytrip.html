{% extends "base.html" %}

{% block content %}
<h2>Update {{ daytrip.title }}</h2>
<div>
    {{ daytrip.date }}<br>
    {{ daytrip.description }}<br>
</div><br>
<div>
    <button id="button-one">Update Trip Information</button>
    <a href="{% url 'delete_daytrip' daytrip_pk=daytrip.pk %}"><button>Delete Trip</button></a>
</div><br>
<div id="form-one" class="hidden">
    <form action="{% url 'edit_daytrip' daytrip_pk=daytrip.pk %}"method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <div>
            <button type="submit">Update Trip</button>
           <a href="{% url 'edit_daytrip' daytrip_pk=daytrip.pk %}"><button>Cancel Update</button></a> 
        </div>
    </form>
</div><br>

<form action="{% url 'edit_daytrip' daytrip_pk=daytrip.pk %}" method="GET">
    <input type="search" name="location" placeholder="Location" value="{{ location_query }}"/>
    <p>
        <button type="submit">Search</button>
    </p>
</form>

<div id='map' style='width: 400px; height: 300px;'></div>
<p>Drag over routes to add them to your trip!</p>
<div id="route-planning-container">
    <div class="route-planning-column">
        <h3>Routes</h3>
        <div id="container1">
            {% for route in routes %}
                {% if route not in planned_routes %}
                <div data-routeid="{{ route.id }}">
                    {{ route.name }} | {{ route.route_type }} | {{ route.rating }}
                </div>
                {% endif %}
            {% empty %}
                <div>Search for routes!</div>
            {% endfor %}
        </div>
    </div>
    <div class="route-planning-column">
        <h3> {{ daytrip.title }} Routes</h3>
        <div id="container2" data-daytripid="{{ daytrip.id }}"><br><br>
                {% for route in planned_routes %}
                <div id="plannedRoute" data-routeid="{{ route.id }}">
                    {{ route.name }} | {{ route.route_type }} | {{ route.rating }}
                </div>
                {% endfor %}
        </div>
        <button id="send-routes-button">Add Routes</button>
    </div>  
</div>

{{ route_info|json_script:"route_info" }}

{% block scripts %}
<script>
// Initalize bounding variables
var minLongitude
var minLatitude
var maxLongitude
var maxLatitude
// Load map and set to variable map
mapboxgl.accessToken = '{{mapbox_access_token}}';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [-80.793457, 35.782169],
    zoom: 4,
})

console.log("map loaded!")
// Event starts as soon the page begins loading
// Get data, load to map, set markers, and initalize bounding varibales
document.addEventListener("DOMContentLoaded", (e) => {
    const route_info = JSON.parse(document.getElementById("route_info").textContent)
    var latitudeList = []
    var longitudeList = []
    for (let i = 0; i < route_info.length; i++) {
        let route = route_info[i]
        latitudeList.push(route.latitude)
        longitudeList.push(route.longitude)
        console.log(route.name)
        var html =  `<div style="border-radius: 3px; width: 200px;">
                        <h4 style="border-radius: 2px;">${route.name}</h4>
                        <div>${route.route_type} | ${route.rating}</div>
                        <a href="/routes/detail/${route.pk}" class="marker-popup">See the route!</a>
                    </div>`
        var customPopUp = new mapboxgl.Popup({
            anchor: "bottom",
            offset: { "bottom" : [0, -10]},
            closeOnClick: false
        }).setHTML(html);

        let color = "green"
        var marker = new mapboxgl.Marker(
            {color: color}
        )
            .setLngLat([route.longitude, route.latitude])
            .setPopup(customPopUp)
            .addTo(map);
    }
    console.log(latitudeList)
    console.log(longitudeList)
    minLongitude = Math.min.apply(Math, longitudeList)
    minLatitude = Math.min.apply(Math, latitudeList)
    maxLongitude = Math.max.apply(Math, longitudeList)
    maxLatitude = Math.max.apply(Math, latitudeList)
    console.log(minLongitude)
    console.log(minLatitude)
    console.log(maxLongitude)
    console.log(maxLatitude)
})
// Bound mapbox after page loads, based on queried data
window.addEventListener('load', (e) => {
        map.fitBounds([
            [(minLongitude - 0.05), (minLatitude - 0.1)],
            [(maxLongitude + 0.1), (maxLatitude + 0.1)]
        ])
        console.log("bounds updated!")
    })
// Dragula functionality 
dragula([
    document.querySelector('#container1'),
    document.querySelector('#container2')
])

.on('drop', (el, target, source, sibling) => {
    if (target === source) {
        console.log("Dropped in same box.")
    } 
    console.log("Dropped in different box.")
    if (target === document.querySelector("#container2")) {
        el.id = "plannedRoute"
        console.log("route id set to planned")
    }
})
// Send array of planned routes to the backend
var sendRoutesButton = document.querySelector("#send-routes-button")
var plannedRoutesContainer = document.querySelector("#container2")

sendRoutesButton.addEventListener("click", function (event) {
    event.preventDefault()
    for (var route of plannedRoutesContainer.querySelectorAll("#plannedRoute")) {
        console.log(route)
        route.pk = route.dataset.routeid
        console.log(route.pk)
        sendRoute(route)
    }
})

var sendRoute = function (route) {
    const daytrip_pk = container2.dataset.daytripid
    const url = `/daytrips/detail/${daytrip_pk}/addroute/${route.pk}`
    fetch(url, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => console.log(data))
}

</script>
{% endblock scripts %}
{% endblock %}